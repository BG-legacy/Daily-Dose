# MongoDB Atlas Migration Guide

## Overview
This project has been migrated from AWS DynamoDB to MongoDB Atlas. This guide will help you understand the changes and how to update your environment.

## What Changed

### Database Layer
- **Before**: AWS DynamoDB with separate table managers
- **After**: MongoDB Atlas with Mongoose ODM
- **Benefits**: 
  - More flexible schema management
  - Better query capabilities
  - Easier local development
  - No AWS credentials needed

### New Files
1. `src/utils/mongodb.js` - MongoDB connection manager
2. `src/models/User.js` - User schema definition
3. `src/models/Journal.js` - Journal entry schema
4. `src/models/Mood.js` - Mood entry schema
5. `src/utils/userManager.js` - MongoDB user operations
6. `src/utils/journalManager.js` - MongoDB journal operations
7. `src/utils/moodManager.js` - MongoDB mood operations

### Updated Files
1. `index.js` - Now connects to MongoDB on startup
2. `src/controller/journalController.js` - Uses new MongoDB managers
3. `src/controller/moodController.js` - Uses new MongoDB manager
4. `src/api/mood.js` - Uses new MongoDB manager
5. `package.json` - Added mongoose dependency

## Environment Setup

### 1. Update Your `.env` File

Your `.env` file should now include:

```env
# MongoDB Atlas Connection
MONGODB_URI=mongodb+srv://bginnjr20_db_user:iQosiKK0oPB01uke@cluster0.nwdw3it.mongodb.net/?appName=Cluster0

# Server Configuration
PORT=3011
NODE_ENV=production

# Frontend URL
FRONTEND_URL=https://www.daily-dose.me

# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id_here
GOOGLE_CLIENT_SECRET=your_google_client_secret_here

# OpenAI (for journal insights)
OPENAI_API_KEY=your_openai_api_key_here
```

### 2. Remove Old AWS Variables

The following variables are **no longer needed** and can be removed:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_REGION`

## Data Migration

### Collections Structure

The MongoDB database uses three collections:

#### 1. Users Collection (`users`)
```javascript
{
  UserID: String,      // Unique user identifier
  Name: String,        // User's display name
  Email: String,       // User's email (indexed, unique)
  CreationDate: Date,  // Account creation date
  createdAt: Date,     // Auto-generated by Mongoose
  updatedAt: Date      // Auto-generated by Mongoose
}
```

#### 2. Journals Collection (`journals`)
```javascript
{
  UserID: String,           // User who created the entry
  Content: String,          // Journal entry content
  Quote: String,            // AI-generated quote
  MentalHealthTip: String,  // AI-generated mental health tip
  Hack: String,             // AI-generated productivity hack
  CreationDate: Date,       // Entry creation date
  Type: String,             // Always "JOURNAL"
  createdAt: Date,          // Auto-generated by Mongoose
  updatedAt: Date           // Auto-generated by Mongoose
}
```

#### 3. Moods Collection (`moods`)
```javascript
{
  UserID: String,      // User who created the entry
  Content: String,     // Mood value: "happy", "sad", or "upset"
  Timestamp: Date,     // Normalized to start of day
  Type: String,        // Always "MOOD"
  CreationDate: Date,  // Actual creation timestamp
  createdAt: Date,     // Auto-generated by Mongoose
  updatedAt: Date      // Auto-generated by Mongoose
}
```

### Migrating Existing Data from DynamoDB

If you have existing data in DynamoDB, you'll need to migrate it. Here's a high-level approach:

1. **Export from DynamoDB**
   - Use AWS CLI or Console to export tables to JSON
   - Tables to export: `Dosers`, `Journals`

2. **Transform the Data**
   - Convert DynamoDB format to MongoDB format
   - Adjust date fields to proper Date objects
   - Separate journal entries from mood entries if they're in the same table

3. **Import to MongoDB Atlas**
   - Use `mongoimport` tool or MongoDB Compass
   - Or write a migration script using the new managers

### Example Migration Script

```javascript
// migration.js
const fs = require('fs');
const UserManager = require('./src/utils/userManager');
const JournalManager = require('./src/utils/journalManager');
const MoodManager = require('./src/utils/moodManager');

async function migrate() {
  // Read DynamoDB exports
  const users = JSON.parse(fs.readFileSync('dynamodb-users.json'));
  const entries = JSON.parse(fs.readFileSync('dynamodb-journals.json'));
  
  const userManager = new UserManager();
  const journalManager = new JournalManager();
  const moodManager = new MoodManager();
  
  // Migrate users
  for (const user of users) {
    await userManager.addUser({
      UserID: user.UserID,
      Name: user.Name,
      Email: user.Email,
      CreationDate: user.CreationDate
    });
  }
  
  // Migrate journal entries
  for (const entry of entries) {
    if (entry.Type === 'JOURNAL') {
      await journalManager.addJournalEntry({
        UserID: entry.UserID,
        Content: entry.Content,
        Quote: entry.Quote,
        MentalHealthTip: entry.MentalHealthTip,
        Hack: entry.Hack,
        Timestamp: entry.CreationDate
      });
    } else if (entry.Type === 'MOOD') {
      await moodManager.addMood({
        UserID: entry.UserID,
        Content: entry.Content
      });
    }
  }
  
  console.log('Migration completed!');
}

migrate().catch(console.error);
```

## Testing the Migration

### 1. Local Testing

```bash
# Install dependencies
npm install

# Start the server
npm run dev

# Check health endpoint
curl http://localhost:3011/health
```

Expected response:
```json
{
  "status": "ok",
  "timestamp": "2025-11-19T...",
  "services": {
    "database": "ok",
    "auth": "ok"
  }
}
```

### 2. Test User Creation

```bash
curl -X POST http://localhost:3011/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "displayName": "Test User"
  }'
```

### 3. Test Journal Entry

```bash
curl -X POST http://localhost:3011/api/journal \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "thought": "Today was a good day!"
  }'
```

### 4. Test Mood Entry

```bash
curl -X POST http://localhost:3011/api/mood \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "content": "happy"
  }'
```

## Deployment Checklist

- [ ] Update `.env` file with MongoDB URI
- [ ] Remove AWS credentials from `.env`
- [ ] Test all API endpoints
- [ ] Migrate existing data (if any)
- [ ] Update deployment configuration (remove AWS dependencies)
- [ ] Deploy to production
- [ ] Monitor logs for any errors
- [ ] Test production endpoints

## Troubleshooting

### Connection Issues

**Problem**: "Failed to connect to MongoDB"

**Solutions**:
1. Verify MongoDB URI is correct in `.env`
2. Check network connectivity to MongoDB Atlas
3. Ensure IP whitelist is configured in MongoDB Atlas
4. Verify database user credentials

### Authentication Errors

**Problem**: "User not found" after migration

**Solutions**:
1. Ensure users were migrated correctly
2. Check email format (MongoDB uses lowercase)
3. Verify UserID format matches

### Missing Data

**Problem**: Entries not showing up

**Solutions**:
1. Check if data was migrated to correct collections
2. Verify Type field is set correctly ("JOURNAL" vs "MOOD")
3. Check date format in queries

## MongoDB Atlas Dashboard

Access your MongoDB Atlas dashboard at: https://cloud.mongodb.com

### Useful Features:
- **Data Explorer**: Browse and query your collections
- **Monitoring**: View database performance metrics
- **Alerts**: Set up alerts for issues
- **Backup**: Configure automatic backups

## Performance Optimization

### Indexes

The following indexes are automatically created:

**Users Collection:**
- `UserID` (unique)
- `Email` (unique)

**Journals Collection:**
- `UserID` + `CreationDate` (descending)
- `UserID` + `Type` + `CreationDate`

**Moods Collection:**
- `UserID` + `Timestamp` (unique)

### Query Performance

Monitor slow queries in MongoDB Atlas and add indexes as needed.

## Rollback Plan

If you need to rollback to DynamoDB:

1. Keep the old files:
   - `src/utils/dynamoDB.js`
   - `src/utils/journalsTable.js`
   - `src/utils/moodTable.js`

2. Revert the controller imports

3. Restore AWS credentials in `.env`

4. Restart the server

## Support

For issues or questions:
1. Check MongoDB Atlas logs
2. Check application logs
3. Review this migration guide
4. Contact the development team

## Next Steps

After successful migration:
1. Monitor application for 24-48 hours
2. Set up MongoDB Atlas alerts
3. Configure backup schedule
4. Remove deprecated AWS-related code
5. Update documentation
6. Train team on MongoDB operations

---

**Migration Date**: November 19, 2025
**Version**: 2.0.0 (MongoDB Atlas)
**Previous Version**: 1.0.0 (AWS DynamoDB)

